apply plugin: 'java'
apply plugin: 'maven'

defaultTasks 'makeOneJar'

group = 'org.wjw.efjson'
version = "2.8.8"
ext {
  buildName = "EasyFastJson"
}

repositories {
  mavenLocal()
  maven{ url "http://SVN:8081/nexus/content/groups/public"}
  mavenCentral()
  jcenter()
//flatDir(dirs: file('jarsDerectory'))
}


dependencies {
  compile files("lib/jackson-annotations-2.8.8.jar")
  compile files("lib/jackson-core-2.8.8.jar")
  compile files("lib/jackson-databind-2.8.8.jar")
//或者:  compile fileTree(dir: "lib", includes: ["*.jar"])
}

sourceSets {
	sourceCompatibility = 1.6
	targetCompatibility = 1.6
	main {
		java {
			srcDirs = ['src']
		}
		resources {
			srcDirs = ['src']
		}
	}
}

jar {  //禁止执行Jar Task
  onlyIf { Task task ->
    return false
  }
}

javadoc {
  failOnError=false
  destinationDir = file("${projectDir}/doc-api")
  title = "${project.buildName}"
  includes = ['org/wjw/efjson/*']

//  doLast {
//    clean.execute()
//  }
}

task makeOneJar(dependsOn: compileJava) {
  doLast{
    def basedir="${projectDir}"
    def oneJarName="${project.buildName}-${project.version}.jar"
    
    ant.echo("Ant Build OneJar:${oneJarName} Start...")
    
    ant.taskdef(name: "jarjar", classname: "com.tonicsystems.jarjar.JarJarTask",  classpath: "lib/jarjar-1.4.jar")
    ant.jarjar(jarfile: "${basedir}/${oneJarName}") {
    	fileset(dir: "${sourceSets['main'].output.classesDir}") {
    		include(name: "**/**")
    	}
    	zipfileset(src: "lib/jackson-annotations-2.8.8.jar")
    	zipfileset(src: "lib/jackson-core-2.8.8.jar")
    	zipfileset(src: "lib/jackson-databind-2.8.8.jar")
    	rule(pattern: "com.fasterxml.jackson.**",result: "org.wjw.efjson.deps.com.fasterxml.jackson.@1")
    }
    
    ant.delete(dir: "${basedir}/doc-api", quiet: "true")
    ant.delete(dir: "${basedir}/tmp", quiet: "true")
    ant.mkdir(dir: "${basedir}/tmp")
    ant.unzip(src: "${basedir}/${oneJarName}", dest: "${basedir}/tmp")
    ant.delete(file: "${basedir}/${oneJarName}")
    
    ant.jar(destfile: "${basedir}/${oneJarName}") {
    	fileset(dir: "${basedir}/tmp") {
    		include(name: "org/**")
    		include(name: "META-INF/services/**")
    	}
    	delegate.manifest {
    		attribute(name: "Built-By", value: "wjw465150@gmail.com")
    		attribute(name: "Build-Name", value: "${project.buildName}")
    		attribute(name: "Build-Version", value: "${project.version}")
    	}
    }
    ant.delete(dir: "${basedir}/tmp", quiet: "true")
    
    ant.echo("Ant Build OneJar:${oneJarName} End!")
    
    ant.copy(file: "${basedir}/${oneJarName}", tofile: "${basedir}/build/libs/${oneJarName}")
    javadoc.execute()
	}
}

uploadArchives {
  repositories.mavenDeployer {
    def mvnUsername = project.findProperty("mvnUsername") ?: ""
    def mvnPassword = project.findProperty("mvnPassword") ?: ""
  
    repository(url: "http://svn:8081/nexus/content/repositories/thirdparty/") {
      authentication(userName: mvnUsername, password: mvnPassword)
    }
    
    pom.groupId = "${project.group}"
    pom.artifactId = "${project.buildName}"
    pom.version = "${project.version}"
    pom.project {
      name project.name
      packaging 'jar'
      description 'Encapsulates Jackon JSON library, Fast Speed Easy Used Json Lib For java'
      
      licenses {
        license {
          name 'The Apache Software License, Version 2.0'
          url 'http://www.apache.org/licenses/LICENSE-2.0.txt'
          distribution 'Encapsulates Jackon JSON library, Fast Speed Easy Used Json Lib For java'
        }
      }
    
      developers {
        developer {
          id 'wangjunwei'
          name 'Wang JunWei'
        }
      }
    }
  }
}

//为项目生成**.jar/**-javadoc.jar/**-sources.jar
task javadocJar(type: Jar, dependsOn: [makeOneJar]) {
    classifier = 'javadoc'
    from 'doc-api'
}

task sourcesJar(type: Jar) {
    classifier = 'sources'
    from sourceSets.main.allSource
}

artifacts {
    archives javadocJar
    archives sourcesJar
}
